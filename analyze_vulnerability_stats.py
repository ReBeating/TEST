#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
分析 outputs/results 目录中的漏洞统计信息
"""

import json
import csv
import os
from pathlib import Path
from collections import defaultdict

def load_checked_list(csv_path):
    """加载 checked_list.csv 文件，返回字典 {vul_id: [judgements]}"""
    vul_judgements = defaultdict(list)
    
    if not os.path.exists(csv_path):
        print(f"警告: {csv_path} 不存在")
        return vul_judgements
    
    with open(csv_path, 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            vul_id = row.get('vul_id', '').strip()
            judgement = row.get('judgement', '').strip()
            if vul_id and judgement:
                vul_judgements[vul_id].append(judgement)
    
    return vul_judgements

def check_findings_not_exist_or_empty(findings_file):
    """
    检查 *_repo_findings.json 是否不存在或为空
    
    返回: True 表示文件不存在或为空
    """
    # 文件不存在
    if findings_file is None or not os.path.exists(findings_file):
        return True
    
    try:
        with open(findings_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # 如果不是列表或为空列表
        if not isinstance(data, list) or len(data) == 0:
            return True
        
        return False  # 文件存在且不为空
    
    except Exception as e:
        print(f"读取 {findings_file} 出错: {e}")
        return True  # 出错时算文件为空

def check_findings_all_false(findings_file):
    """
    检查 *_repo_findings.json 是否所有 item 的 is_vulnerable 都为 false
    
    返回: True 表示所有 item 都是 false（不包括文件不存在或为空的情况）
    """
    # 文件不存在或为空，不满足条件
    if findings_file is None or not os.path.exists(findings_file):
        return False
    
    try:
        with open(findings_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # 如果不是列表或为空列表，不满足条件
        if not isinstance(data, list) or len(data) == 0:
            return False
        
        # 检查是否所有 item 的 is_vulnerable 都为 false
        for item in data:
            if isinstance(item, dict):
                is_vulnerable = item.get('is_vulnerable', False)
                if is_vulnerable:  # 如果有任何一个为 true
                    return False
        
        return True  # 所有都是 false
    
    except Exception as e:
        print(f"读取 {findings_file} 出错: {e}")
        return False  # 出错时不满足条件

def check_findings_has_true(findings_file):
    """
    检查 *_repo_findings.json 是否有 item 的 is_vulnerable 为 true
    
    返回: True 表示至少有一个 item 的 is_vulnerable 为 true
    """
    if not os.path.exists(findings_file):
        return False
    
    try:
        with open(findings_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        if not isinstance(data, list) or len(data) == 0:
            return False
        
        # 检查是否有任何 item 的 is_vulnerable 为 true
        for item in data:
            if isinstance(item, dict):
                is_vulnerable = item.get('is_vulnerable', False)
                if is_vulnerable:
                    return True
        
        return False
    
    except Exception as e:
        print(f"读取 {findings_file} 出错: {e}")
        return False

def find_all_vulnerabilities(results_dir):
    """
    遍历 outputs/results 目录，找到所有漏洞及其相关文件
    
    返回: {vul_id: {'candidates': path, 'findings': path}}
    """
    vulnerabilities = defaultdict(lambda: {'candidates': None, 'findings': None})
    
    results_path = Path(results_dir)
    if not results_path.exists():
        print(f"错误: {results_dir} 目录不存在")
        return vulnerabilities
    
    # 遍历所有组织/仓库目录
    for org_dir in results_path.iterdir():
        if not org_dir.is_dir():
            continue
        
        for repo_dir in org_dir.iterdir():
            if not repo_dir.is_dir():
                continue
            
            # 查找该仓库中的所有 JSON 文件
            for json_file in repo_dir.glob('*.json'):
                filename = json_file.name
                
                # 提取 CVE-ID
                if '_repo_candidates.json' in filename:
                    vul_id = filename.replace('_repo_candidates.json', '')
                    vulnerabilities[vul_id]['candidates'] = str(json_file)
                
                elif '_repo_findings.json' in filename:
                    vul_id = filename.replace('_repo_findings.json', '')
                    vulnerabilities[vul_id]['findings'] = str(json_file)
    
    return vulnerabilities

def main():
    # 配置路径
    results_dir = 'outputs/results'
    checked_list_path = 'results/checked_list.csv'
    
    print("=" * 80)
    print("开始分析漏洞统计信息...")
    print("=" * 80)
    
    # 加载 checked_list.csv
    print(f"\n加载 {checked_list_path}...")
    vul_judgements = load_checked_list(checked_list_path)
    print(f"已加载 {len(vul_judgements)} 个漏洞的判断结果")
    
    # 查找所有漏洞
    print(f"\n扫描 {results_dir} 目录...")
    vulnerabilities = find_all_vulnerabilities(results_dir)
    print(f"找到 {len(vulnerabilities)} 个漏洞")
    
    # 任务 1: 统计 findings 文件不存在或为空的漏洞
    print("\n" + "=" * 80)
    print("任务 1: 统计 *_repo_findings.json 不存在或为空的漏洞")
    print("=" * 80)
    
    task1_count = 0
    task1_vuls = []
    
    for vul_id, files in vulnerabilities.items():
        findings_file = files['findings']
        if check_findings_not_exist_or_empty(findings_file):
            task1_count += 1
            task1_vuls.append(vul_id)
    
    print(f"\n满足条件的漏洞数量: {task1_count}")
    print(f"漏洞占比: {task1_count}/{len(vulnerabilities)} = {task1_count/len(vulnerabilities)*100:.2f}%")
    
    # 任务 2: 统计 findings 中所有 item 的 is_vulnerable 都为 false 的漏洞
    print("\n" + "=" * 80)
    print("任务 2: 统计 *_repo_findings.json 中所有 item 的 is_vulnerable")
    print("        都为 false 的漏洞")
    print("=" * 80)
    
    task2_count = 0
    task2_vuls = []
    
    for vul_id, files in vulnerabilities.items():
        findings_file = files['findings']
        if check_findings_all_false(findings_file):
            task2_count += 1
            task2_vuls.append(vul_id)
    
    print(f"\n满足条件的漏洞数量: {task2_count}")
    print(f"漏洞占比: {task2_count}/{len(vulnerabilities)} = {task2_count/len(vulnerabilities)*100:.2f}%")
    
    # 任务 3: 统计 findings 中有 is_vulnerable=true 的漏洞，并分析其 TP/FP/Unknown 情况
    print("\n" + "=" * 80)
    print("任务 3: 统计 *_repo_findings.json 中有 item 的 is_vulnerable 为 true 的漏洞")
    print("        并分析其在 checked_list.csv 中的 TP/FP/Unknown 情况")
    print("=" * 80)
    
    task3_vuls_with_true = []
    tp_vuls = []
    fp_vuls = []
    unknown_vuls = []
    mixed_vuls = []
    not_in_csv_vuls = []
    fp_only_vuls = []  # 只有 FP 的漏洞
    
    for vul_id, files in vulnerabilities.items():
        findings_file = files['findings']
        if findings_file and check_findings_has_true(findings_file):
            task3_vuls_with_true.append(vul_id)
            
            # 检查该漏洞在 checked_list.csv 中的判断结果
            judgements = vul_judgements.get(vul_id, [])
            
            if not judgements:
                not_in_csv_vuls.append(vul_id)
            else:
                # 统计 TP/FP/Unknown 的数量
                tp_count = judgements.count('TP')
                fp_count = judgements.count('FP')
                unknown_count = len([j for j in judgements if j not in ['TP', 'FP']])
                
                # 分类
                if fp_count > 0 and tp_count == 0 and unknown_count == 0:
                    # 只有 FP
                    fp_only_vuls.append(vul_id)
                    fp_vuls.append(vul_id)
                elif tp_count > 0 and fp_count == 0 and unknown_count == 0:
                    # 只有 TP
                    tp_vuls.append(vul_id)
                elif unknown_count > 0 and tp_count == 0 and fp_count == 0:
                    # 只有 Unknown
                    unknown_vuls.append(vul_id)
                else:
                    # 混合情况
                    mixed_vuls.append((vul_id, f"TP:{tp_count}, FP:{fp_count}, Unknown:{unknown_count}"))
                    if fp_count > 0:
                        fp_vuls.append(vul_id)
                    if tp_count > 0:
                        tp_vuls.append(vul_id)
                    if unknown_count > 0:
                        unknown_vuls.append(vul_id)
    
    print(f"\nis_vulnerable=true 的漏洞数量: {len(task3_vuls_with_true)}")
    print(f"\n在 checked_list.csv 中的分类统计:")
    print(f"  - 包含 TP 的漏洞: {len(tp_vuls)}")
    print(f"  - 包含 FP 的漏洞: {len(fp_vuls)}")
    print(f"  - 包含 Unknown 的漏洞: {len(unknown_vuls)}")
    print(f"  - 不在 CSV 中的漏洞: {len(not_in_csv_vuls)}")
    
    print(f"\n只有 FP 的漏洞数量: {len(fp_only_vuls)}")
    if fp_only_vuls:
        print("\n只有 FP 的漏洞列表:")
        for vul_id in sorted(fp_only_vuls):
            print(f"  - {vul_id}")
    
    if mixed_vuls:
        print(f"\n混合判断结果的漏洞 ({len(mixed_vuls)} 个):")
        for vul_id, stats in sorted(mixed_vuls):
            print(f"  - {vul_id}: {stats}")
    
    # 输出总结
    print("\n" + "=" * 80)
    print("统计总结")
    print("=" * 80)
    print(f"总漏洞数量: {len(vulnerabilities)}")
    print(f"")
    print(f"任务1 - findings 文件不存在或为空的漏洞: {task1_count} ({task1_count/len(vulnerabilities)*100:.2f}%)")
    print(f"任务2 - findings 中所有 is_vulnerable 都为 false 的漏洞: {task2_count} ({task2_count/len(vulnerabilities)*100:.2f}%)")
    print(f"任务3 - findings 中有 is_vulnerable=true 的漏洞: {len(task3_vuls_with_true)} ({len(task3_vuls_with_true)/len(vulnerabilities)*100:.2f}%)")
    print(f"  └─ 其中只有 FP 的漏洞: {len(fp_only_vuls)} ({len(fp_only_vuls)/len(task3_vuls_with_true)*100 if task3_vuls_with_true else 0:.2f}%)")
    print("=" * 80)

if __name__ == '__main__':
    main()
